<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Parcel Booking - Aup Grab</title>
  <link rel="stylesheet" href="info-modal.css">
  <link rel="stylesheet" href="notifications.css">
  <link rel="stylesheet" href="notification-banner.css">
  <script src="notification-service.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #2d5016 0%, #4a7c59 50%, #6b8e23 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      animation: slideUp 0.8s ease-out;
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .header {
      background: linear-gradient(135deg, #4a7c59, #2d5016);
      color: white;
      padding: 30px;
      text-align: center;
      position: relative;
    }
    
    .back-btn {
      position: absolute;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.3s;
    }
    
    .back-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .header h1 {
      font-size: 2rem;
      margin-bottom: 10px;
    }
    
    .header-icon {
      margin-bottom: 15px;
    }
    
    .header-icon svg {
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }
    
    .header p {
      opacity: 0.9;
      font-size: 1.1rem;
    }
    
    .form-container {
      padding: 40px 30px;
    }
    
    .user-session {
      background: #e8f5e8;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 30px;
      border-left: 4px solid #4a7c59;
    }
    
    .user-id {
      font-family: monospace;
      font-weight: bold;
      color: #2d5016;
      background: rgba(255,255,255,0.7);
      padding: 4px 8px;
      border-radius: 4px;
      display: inline-block;
      margin-left: 5px;
    }
    
    .form-group {
      margin-bottom: 25px;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #2d5016;
      font-size: 1rem;
    }
    
    .required {
      color: #dc3545;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e1e1e1;
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.3s ease;
      background: #fafafa;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #4a7c59;
      background: white;
      box-shadow: 0 0 0 3px rgba(74, 124, 89, 0.1);
    }
    
    .input-error {
      border-color: #dc3545 !important;
      background: #fff5f5 !important;
    }
    
    .error-message {
      color: #dc3545;
      font-size: 14px;
      margin-top: 5px;
      display: none;
    }
    
    .quantity-group {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .quantity-input {
      width: 100px !important;
      text-align: center;
      font-weight: bold;
    }
    
    .quantity-controls {
      display: flex;
      gap: 5px;
    }
    
    .quantity-btn {
      width: 40px;
      height: 40px;
      background: #4a7c59;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .quantity-btn:hover {
      background: #2d5016;
      transform: scale(1.05);
    }
    
    .quantity-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    .payment-cost-group {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin-top: 15px;
      border-left: 4px solid #4a7c59;
      display: none;
    }
    
    .payment-cost-group.show {
      display: block;
      animation: slideDown 0.3s ease-out;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .rider-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    
    .rider-option {
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }
    
    .rider-option:hover {
      border-color: #4a7c59;
      background: #e8f5e8;
    }
    
    .rider-option.selected {
      border-color: #4a7c59;
      background: #e8f5e8;
      font-weight: bold;
    }
    
    .submit-btn {
      width: 100%;
      background: linear-gradient(135deg, #4a7c59, #2d5016);
      color: white;
      border: none;
      padding: 18px;
      border-radius: 12px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 20px;
    }
    
    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(74, 124, 89, 0.3);
    }
    
    .submit-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .status-section {
      background: #f8f9fa;
      padding: 30px;
      border-top: 1px solid #e9ecef;
      display: none;
    }
    
    .success-message {
      background: #d4edda;
      color: #155724;
      padding: 20px;
      border-radius: 10px;
      border: 1px solid #c3e6cb;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .order-id-display {
      background: #e8f5e8;
      padding: 20px;
      border-radius: 10px;
      border: 2px solid #4a7c59;
      text-align: center;
      margin: 20px 0;
    }
    
    .order-id {
      font-family: monospace;
      font-size: 1.5rem;
      font-weight: bold;
      color: #2d5016;
    }
    
    .rider-status {
      text-align: center;
      padding: 20px;
      font-size: 1.1rem;
      color: #666;
    }
    
    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 10px;
      animation: pulse 2s infinite;
    }
    
    .status-waiting {
      background: #ffc107;
    }
    
    .status-assigned {
      background: #4a7c59;
      animation: none;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
    
    .rider-info {
      background: linear-gradient(135deg, #4a7c59, #2d5016);
      color: white;
      padding: 25px;
      border-radius: 15px;
      margin: 20px 0;
      text-align: center;
      animation: slideIn 0.5s ease-out;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    .rider-info h3 {
      margin-bottom: 15px;
      font-size: 1.5rem;
    }
    
    .rider-details {
      font-size: 1.1rem;
      margin: 8px 0;
    }
    
    .confirm-btn {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
      transition: all 0.3s;
    }
    
    .confirm-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(40, 167, 69, 0.3);
    }
    
    .completed-message {
      background: linear-gradient(135deg, #4a7c59, #2d5016);
      color: white;
      padding: 25px;
      border-radius: 15px;
      text-align: center;
      animation: slideIn 0.5s ease-out;
    }

    /* Enhanced rider card UI (uniform across pages) */
    .rider-info .rider-grid { display: grid; grid-template-columns: 72px 1fr; gap: 16px; align-items: center; text-align: left; }
    .rider-info .avatar { width: 72px; height: 72px; border-radius: 50%; background: rgba(255,255,255,0.2); display:flex; align-items:center; justify-content:center; font-weight: 800; font-size: 1.25rem; box-shadow: inset 0 2px 8px rgba(0,0,0,0.25); }
    .rider-info .name-row { display:flex; align-items:center; gap:10px; margin-bottom: 6px; }
    .rider-info .pill { display:inline-block; padding: 4px 10px; border-radius: 999px; background: rgba(255,255,255,0.18); font-size: 0.8rem; font-weight: 700; letter-spacing: .3px; }
    .rider-info .rider-actions { margin-top: 12px; display:flex; gap:10px; flex-wrap: wrap; }
    .contact-btn { background: rgba(255,255,255,0.15); color: #fff; border: 1px solid rgba(255,255,255,0.3); padding: 10px 14px; border-radius: 10px; font-weight: 700; text-decoration: none; transition: all .2s; }
    .contact-btn:hover { background: rgba(255,255,255,0.25); transform: translateY(-1px); }
    .progress { margin-top: 12px; }
    .progress-track { width: 100%; height: 8px; background: rgba(255,255,255,0.25); border-radius: 999px; overflow:hidden; }
    .progress-fill { height: 100%; width: 35%; background: linear-gradient(90deg, #7c4dff, #18ffff); border-radius: 999px; box-shadow: 0 0 10px rgba(24,255,255,0.5); transition: width .3s ease; }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      .container {
        margin: 10px;
        border-radius: 15px;
      }
      
      .form-container {
        padding: 30px 20px;
      }
      
      .form-row {
        grid-template-columns: 1fr;
        gap: 0;
      }
      
      .rider-options {
        grid-template-columns: 1fr;
      }
      
      .quantity-group {
        justify-content: center;
      }
      
      .back-btn {
        left: 15px;
        padding: 8px 12px;
        font-size: 14px;
      }
      
      /* Improve rider info card for mobile - prevent overlapping */
      .rider-info {
        padding: 20px 15px;
        margin: 15px 0;
      }
      
      /* More compact messaging area */
      #messagesContainer {
        margin-top: 10px !important;
      }
      
      #messagesList {
        max-height: 140px !important;
        font-size: 14px;
      }
      
      /* Ensure rider details don't overflow */
      .rider-details {
        font-size: 0.95rem;
        line-height: 1.4;
        word-break: break-word;
        margin: 6px 0;
      }
    }

    /* More aggressive adjustments for very small screens */
    @media (max-width: 420px) {
      /* Existing mobile header adjustments */
      /* ...existing code... */
      
      /* Properly scale down rider card */
      .rider-info {
        padding: 15px 12px;
      }
      
      /* More compact avatar */
      .rider-info .rider-grid {
        grid-template-columns: 48px 1fr !important;
        gap: 10px !important;
      }
      
      .rider-info .avatar {
        width: 48px !important;
        height: 48px !important;
        font-size: 0.9rem !important;
      }
      
      /* Better name/title layout for small screens */
      .rider-info .name-row {
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 4px;
      }
      
      .rider-info .name-row h3 {
        font-size: 1.1rem;
        line-height: 1.2;
      }
      
      /* Stack actions vertically and make them full width */
      .rider-info .rider-actions {
        flex-direction: column;
        gap: 8px;
        margin-top: 10px;
      }
      
      .rider-info .rider-actions .contact-btn {
        width: 100%;
        text-align: center;
        padding: 12px;
      }
      
      /* Make the message container more compact */
      #messagesContainer {
        margin-top: 12px !important;
      }
      
      #messagesContainer > div:first-child {
        font-size: 0.9rem;
        margin-bottom: 4px;
      }
      
      #messagesList {
        max-height: 120px !important;
        padding: 8px !important;
      }
    }

    /* Extra small devices like iPhone SE */
    @media (max-width: 360px) {
      .rider-info {
        padding: 12px 10px;
      }
      
      .rider-info .rider-grid {
        grid-template-columns: 40px 1fr !important;
        gap: 8px !important;
      }
      
      .rider-info .avatar {
        width: 40px !important;
        height: 40px !important;
      }
      
      .rider-details {
        font-size: 0.85rem;
        margin: 4px 0;
      }
      
      /* Make the progress bar more visible on small screens */
      .progress-track {
        height: 6px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <button class="back-btn" onclick="goBack()">‚Üê Back</button>
      <button class="info-btn" onclick="openInfo()" aria-label="How to use">i</button>
      <div class="header-icon">
        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/>
          <path d="m3.3 7 8.7 5 8.7-5"/>
          <path d="M12 22V12"/>
        </svg>
      </div>
      <h1>Parcel Booking</h1>
      <p>Fast and secure package delivery service</p>
    </div>
    
    <!-- Shared Info Modal -->
    <div id="infoModal" class="modal-overlay" onclick="overlayClick(event)">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="parcelInfoTitle">
        <div class="modal-header">
          <h3 id="parcelInfoTitle">How Parcel Booking Works</h3>
          <button class="close-btn" onclick="closeInfo()" aria-label="Close">Close</button>
        </div>
        <div class="modal-body">
          <h4>Steps</h4>
          <ul>
            <li>Fill in sender and receiver details with accurate contact numbers.</li>
            <li>Provide pickup and delivery locations. Add helpful notes if needed (e.g., building, gate info).</li>
            <li>Select quantity and review any shown cost/payment info.</li>
            <li>Submit your booking. We will look for the nearest available rider.</li>
            <li>Once a rider is assigned, you will see rider details and can chat/confirm delivery.</li>
            <li>After receiving the parcel, tap Confirm to complete the booking.</li>
          </ul>
          <h4>Tips</h4>
          <ul>
            <li>Keep your phone available so the rider can contact you.</li>
            <li>Fragile or special items: include clear instructions in notes.</li>
            <li>For large items, consider using a box or crate to protect the parcel.</li>
        <h4>Call</h4>
            <li>For more information, please call us at 0992-278-8477.</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- User Session Info -->
    <div class="form-container">
      <div class="user-session">
        <strong>Your Session:</strong>
        <span class="user-id" id="userSessionId"></span>
        <div style="font-size: 12px; color: #666; margin-top: 5px;">
          This ID helps track your booking
        </div>
      </div>
      
      <!-- Booking Form -->
      <!-- Add ID to the form element -->
      <form id="parcelForm">
        <!-- Personal Information -->
        <div class="form-row">
          <div class="form-group">
            <label for="customerName">Your Name <span class="required">*</span></label>
            <input type="text" id="customerName" placeholder="Enter your full name" required>
            <div class="error-message" id="nameError">Please enter your full name</div>
          </div>
          
          <div class="form-group">
            <label for="customerPhone">Phone Number <span class="required">*</span></label>
            <input type="tel" id="customerPhone" placeholder="09123456789" required>
            <div class="error-message" id="phoneError">Please enter a valid phone number</div>
          </div>
        </div>
        
        <!-- Rider Selection (multiple with per-option count) -->
        <div class="form-group">
          <label>Select Rider(s) and quantity per rider <span class="required">*</span></label>
          <div class="rider-options">
            <div class="rider-option">
              <label style="display:flex; align-items:center; justify-content:space-between; gap:8px; width:100%;">
                <span><strong>SPX</strong><br>Kuya Ronald</span>
                <span>
                  <input type="checkbox" class="rider-check" data-rider="SPX - Kuya Ronald" />
                  <input type="number" class="rider-count" min="1" value="1" style="width:70px; margin-left:6px;" disabled />
                </span>
              </label>
            </div>
            <div class="rider-option">
              <label style="display:flex; align-items:center; justify-content:space-between; gap:8px; width:100%;">
                <span><strong>SPX</strong><br>Kuya Neil</span>
                <span>
                  <input type="checkbox" class="rider-check" data-rider="SPX - Kuya Neil" />
                  <input type="number" class="rider-count" min="1" value="1" style="width:70px; margin-left:6px;" disabled />
                </span>
              </label>
            </div>
            <div class="rider-option">
              <label style="display:flex; align-items:center; justify-content:space-between; gap:8px; width:100%;">
                <span><strong>Flash</strong><br>Kuya Mark</span>
                <span>
                  <input type="checkbox" class="rider-check" data-rider="Flash - Kuya Mark" />
                  <input type="number" class="rider-count" min="1" value="1" style="width:70px; margin-left:6px;" disabled />
                </span>
              </label>
            </div>
            <div class="rider-option">
              <label style="display:flex; align-items:center; justify-content:space-between; gap:8px; width:100%;">
                <span><strong>J&T</strong><br>Ate Gemma</span>
                <span>
                  <input type="checkbox" class="rider-check" data-rider="J&T - Ate Gemma" />
                  <input type="number" class="rider-count" min="1" value="1" style="width:70px; margin-left:6px;" disabled />
                </span>
              </label>
            </div>
            <div class="rider-option">
              <label style="display:flex; align-items:center; justify-content:space-between; gap:8px; width:100%;">
                <span><strong>J&T</strong><br>Ate Kristina</span>
                <span>
                  <input type="checkbox" class="rider-check" data-rider="J&T - Ate Kristina" />
                  <input type="number" class="rider-count" min="1" value="1" style="width:70px; margin-left:6px;" disabled />
                </span>
              </label>
            </div>
            <div class="rider-option">
              <label style="display:flex; align-items:center; justify-content:space-between; gap:8px; width:100%;">
                <span><strong>YTO</strong><br>Available</span>
                <span>
                  <input type="checkbox" class="rider-check" data-rider="YTO" />
                  <input type="number" class="rider-count" min="1" value="1" style="width:70px; margin-left:6px;" disabled />
                </span>
              </label>
            </div>
            <div class="rider-option">
              <label style="display:flex; align-items:center; justify-content:space-between; gap:8px; width:100%;">
                <span><strong>LAZADA</strong><br>Available</span>
                <span>
                  <input type="checkbox" class="rider-check" data-rider="LAZADA" />
                  <input type="number" class="rider-count" min="1" value="1" style="width:70px; margin-left:6px;" disabled />
                </span>
              </label>
            </div>
          </div>
          <div class="error-message" id="riderError">Please select at least one option and set quantity</div>
        </div>
        
        <!-- Quantity -->
        <div class="form-group">
          <label for="quantity">Quantity <span class="required">*</span></label>
          <div class="quantity-group">
            <div class="quantity-controls">
              <button type="button" class="quantity-btn" onclick="adjustQuantity(-1)">-</button>
              <button type="button" class="quantity-btn" onclick="adjustQuantity(1)">+</button>
            </div>
            <input type="number" id="quantity" class="quantity-input" value="1" min="1" max="99" required>
            <span style="color: #666;">packages</span>
          </div>
          <div class="error-message" id="quantityError">Please enter a valid quantity</div>
        </div>
        
        <!-- Payment Status -->
        <div class="form-group">
          <label for="paymentStatus">Payment Status <span class="required">*</span></label>
          <select id="paymentStatus" required>
            <option value="">Select payment status</option>
            <option value="Paid">Already Paid</option>
            <option value="Not Yet Paid">Not Yet Paid</option>
          </select>
          <div class="error-message" id="paymentError">Please select payment status</div>
          
          <div class="payment-cost-group" id="paymentCostGroup">
            <label for="paymentCost">How much to collect? <span class="required">*</span></label>
            <input type="number" id="paymentCost" placeholder="Enter amount (e.g., 250.00)" step="0.01" min="0">
            <div style="font-size: 12px; color: #666; margin-top: 5px;">
              Amount the rider needs to collect from recipient
            </div>
            
            <!-- Add payment method options -->
            <div style="margin-top: 10px;">
              <label>Payment Method <span class="required">*</span></label>
              <div style="display: flex; gap: 20px; margin-top: 8px;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                  <input type="radio" name="paymentMethod" value="Cash" checked style="width: auto; margin-right: 8px;">
                  Cash
                </label>
                <label style="display: flex; align-items: center; cursor: pointer;">
                  <input type="radio" name="paymentMethod" value="GCash" style="width: auto; margin-right: 8px;">
                  GCash
                </label>
              </div>
            </div>
            
            <div class="error-message" id="paymentCostError">Please enter the payment amount</div>
          </div>
        </div>
        
        <!-- Delivery Location -->
        <div class="form-group">
          <label for="deliveryLocation">Where to be delivered? <span class="required">*</span></label>
          <textarea id="deliveryLocation" placeholder="Enter complete delivery address" rows="3" required></textarea>
          <div class="error-message" id="deliveryError">Please enter delivery location</div>
        </div>
        
        <!-- Notes -->
        <div class="form-group">
          <label for="notes">Additional Notes</label>
          <textarea id="notes" placeholder="Special instructions, fragile items, etc." rows="3"></textarea>
        </div>
        
        <!-- Submit Button -->
        <button type="submit" class="submit-btn" id="submitBtn">
          Submit Parcel Booking
        </button>
      </form>
    </div>
    
    <!-- Status Section -->
    <div class="status-section" id="statusSection">
      <div class="success-message" id="successMessage"></div>
      <div class="order-id-display" id="orderIdDisplay"></div>
      <!-- Booking summary -->
      <div id="bookingSummary" style="margin-bottom:18px; display:none;"></div>
      <div class="rider-status" id="riderStatus">
        <span class="status-indicator status-waiting"></span>
        Looking for available rider...
      </div>
      <div id="riderInfo"></div>
      <div id="orderActions"></div>
      <div id="completedMessage"></div>
    </div>
  </div>

  <div id="notification-banner">
    <p>Do you want to receive booking updates when your rider is assigned?</p>
    <div class="buttons">
        <button id="notify-yes">Yes</button>
        <button id="notify-no">No</button>
    </div>
  </div>
  
  <script>
    // REPLACE WITH YOUR GOOGLE APP SCRIPT URL
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzv69YVjiAxzYteFo7tl4LGVecznj35_kRYY4_Eca3IPmAnOouSQgTIwTqdXESQOrEP2A/exec';
    
    let userSessionId = null;
    let currentOrderId = null;
    let selectedRider = null;
    let checkInterval = null;
    let messageInterval = null;
    let lastMessageTs = null;
    const STORAGE_KEY = 'currentParcelOrder';
    let lastKnownDeliveryStatus = null;
    
    // Initialize session
    window.onload = function() {
      initializeSession();
      setupEventListeners();
      restoreFromStorage();
    };
    
    function initializeSession() {
      userSessionId = localStorage.getItem('userSessionId');
      if (!userSessionId) {
        userSessionId = generateSessionId();
        localStorage.setItem('userSessionId', userSessionId);
      }
      document.getElementById('userSessionId').textContent = userSessionId;
    }
    
    function generateSessionId() {
      const timestamp = Date.now();
      const random = Math.floor(Math.random() * 10000);
      return `USER-${timestamp}-${random}`;
    }
    
    // Hold selections as { name: count }
    let riderSelections = {};

    function setupEventListeners() {
      // Multi rider selection with counts
      document.querySelectorAll('.rider-option').forEach(option => {
        const check = option.querySelector('.rider-check');
        const count = option.querySelector('.rider-count');
        if (!check || !count) return;

        // Add +/- controls next to each count input
        const minusBtn = document.createElement('button');
        minusBtn.type = 'button';
        minusBtn.textContent = '‚àí';
        minusBtn.className = 'count-btn count-minus';
        minusBtn.style.cssText = 'margin-left:6px; width:28px; height:28px; border-radius:6px; border:none; background:#eee; color:#000;';

        const plusBtn = document.createElement('button');
        plusBtn.type = 'button';
        plusBtn.textContent = '+';
        plusBtn.className = 'count-btn count-plus';
        plusBtn.style.cssText = 'margin-left:4px; width:28px; height:28px; border-radius:6px; border:none; background:#eee; color:#000;';

        // Insert buttons after the input
        count.parentNode.insertBefore(minusBtn, count.nextSibling);
        count.parentNode.insertBefore(plusBtn, minusBtn.nextSibling);

        function setEnabled(enabled) {
          count.disabled = !enabled;
          minusBtn.disabled = !enabled;
          plusBtn.disabled = !enabled;
          if (!enabled) {
            // Reset visual if unselected; keep value but remove from selection map
            option.classList.remove('selected');
          }
        }

        // Initialize disabled state
        setEnabled(check.checked);

        check.addEventListener('change', () => {
          if (check.checked) {
            setEnabled(true);
            const c = parseInt(count.value) || 1;
            riderSelections[check.dataset.rider] = c;
            option.classList.add('selected');
          } else {
            setEnabled(false);
            delete riderSelections[check.dataset.rider];
            option.classList.remove('selected');
          }
          updateTotalQuantityFromSelections();
        });

        count.addEventListener('input', () => {
          let v = parseInt(count.value) || 1;
          if (v < 1) v = 1;
          if (v > 99) v = 99;
          count.value = v;
          if (check.checked) {
            riderSelections[check.dataset.rider] = v;
          }
          updateTotalQuantityFromSelections();
        });

        minusBtn.addEventListener('click', () => {
          if (!check.checked) return;
          let v = parseInt(count.value) || 1;
          v = Math.max(1, v - 1);
          count.value = v;
          riderSelections[check.dataset.rider] = v;
          updateTotalQuantityFromSelections();
        });

        plusBtn.addEventListener('click', () => {
          if (!check.checked) return;
          let v = parseInt(count.value) || 1;
          v = Math.min(99, v + 1);
          count.value = v;
          riderSelections[check.dataset.rider] = v;
          updateTotalQuantityFromSelections();
        });
      });
      
      // Payment status change
      document.getElementById('paymentStatus').addEventListener('change', function() {
        const costGroup = document.getElementById('paymentCostGroup');
        if (this.value === 'Not Yet Paid') {
          costGroup.classList.add('show');
          document.getElementById('paymentCost').required = true;
        } else {
          costGroup.classList.remove('show');
          document.getElementById('paymentCost').required = false;
        }
      });
      
      // Form submission
      const form = document.getElementById('parcelForm');
      if (form) {
        form.addEventListener('submit', handleSubmit);
      } else {
        console.error("Form element with ID 'parcelForm' not found");
      }
    }
    
    function updateTotalQuantityFromSelections() {
      const total = Object.values(riderSelections).reduce((sum, v) => sum + (parseInt(v) || 0), 0);
      const quantityInput = document.getElementById('quantity');
      quantityInput.value = Math.max(total, 1);
    }

    function adjustQuantity(change) {
      // Manual adjustment allowed, but will be overridden by selections if any are checked
      const anySelected = Object.keys(riderSelections).length > 0;
      const quantityInput = document.getElementById('quantity');
      let currentValue = parseInt(quantityInput.value) || 1;
      let newValue = currentValue + change;
      if (newValue < 1) newValue = 1;
      if (newValue > 99) newValue = 99;
      quantityInput.value = newValue;
      if (!anySelected) return;
    }
    
    function validateForm() {
      let isValid = true;
      
      // Clear previous errors
      document.querySelectorAll('.error-message').forEach(msg => msg.style.display = 'none');
      document.querySelectorAll('.input-error').forEach(input => input.classList.remove('input-error'));
      
      // Validate name
      const name = document.getElementById('customerName').value.trim();
      if (!name) {
        showError('customerName', 'nameError', 'Please enter your full name');
        isValid = false;
      }
      
      // Validate phone
      const phone = document.getElementById('customerPhone').value.trim();
      if (!phone || phone.length < 10) {
        showError('customerPhone', 'phoneError', 'Please enter a valid phone number');
        isValid = false;
      }
      
      // Validate rider selections
      const selectedNames = Object.keys(riderSelections);
      if (selectedNames.length === 0) {
        document.getElementById('riderError').style.display = 'block';
        isValid = false;
      }
      
      // Validate quantity (auto-summed)
      const quantity = parseInt(document.getElementById('quantity').value);
      if (!quantity || quantity < 1) {
        showError('quantity', 'quantityError', 'Please enter a valid quantity');
        isValid = false;
      }
      
      // Validate payment status
      const paymentStatus = document.getElementById('paymentStatus').value;
      if (!paymentStatus) {
        showError('paymentStatus', 'paymentError', 'Please select payment status');
        isValid = false;
      }
      
      // Validate payment cost if not yet paid
      if (paymentStatus === 'Not Yet Paid') {
        const paymentCost = parseFloat(document.getElementById('paymentCost').value);
        if (!paymentCost || paymentCost <= 0) {
          showError('paymentCost', 'paymentCostError', 'Please enter the payment amount');
          isValid = false;
        }
      }
      
      // Validate delivery location
      const deliveryLocation = document.getElementById('deliveryLocation').value.trim();
      if (!deliveryLocation) {
        showError('deliveryLocation', 'deliveryError', 'Please enter delivery location');
        isValid = false;
      }
      
      return isValid;
    }
    
    function showError(inputId, errorId, message) {
      document.getElementById(inputId).classList.add('input-error');
      const errorElement = document.getElementById(errorId);
      errorElement.textContent = message;
      errorElement.style.display = 'block';
    }
    
    let lastBookingDetails = null;

    function handleSubmit(e) {
      e.preventDefault();
      if (!validateForm()) return;
      
      // Ask for notification permission but don't disrupt the flow
      setTimeout(() => checkNotificationPermission(), 100);
      
      lastBookingDetails = {
        customerName: document.getElementById('customerName').value.trim(),
        customerPhone: document.getElementById('customerPhone').value.trim(),
        riderSelections: Object.assign({}, riderSelections),
        quantity: parseInt(document.getElementById('quantity').value),
        paymentStatus: document.getElementById('paymentStatus').value,
        paymentCost: document.getElementById('paymentStatus').value === 'Not Yet Paid' ? parseFloat(document.getElementById('paymentCost').value) : 0,
        paymentMethod: document.getElementById('paymentStatus').value === 'Not Yet Paid' ? 
                       document.querySelector('input[name="paymentMethod"]:checked').value : '',
        deliveryLocation: document.getElementById('deliveryLocation').value.trim(),
        notes: document.getElementById('notes').value.trim()
      };
      
      // Build rider breakdown and ensure total quantity is sum of selections
      const selectedNames = Object.keys(riderSelections);
      const breakdownParts = selectedNames.map(name => `${name} - ${riderSelections[name]}pcs parcel`);
      const totalQty = selectedNames.reduce((sum, name) => sum + (parseInt(riderSelections[name]) || 0), 0);
      const quantityInput = document.getElementById('quantity');
      if (totalQty > 0) quantityInput.value = totalQty;

      const notesEl = document.getElementById('notes');
      const existingNotes = (notesEl.value || '').trim();
      const breakdownText = breakdownParts.length ? `Parcel breakdown: ${breakdownParts.join('; ')}` : '';
      notesEl.value = existingNotes ? `${existingNotes}\n${breakdownText}` : breakdownText;

      const formData = {
        action: 'submit_booking',
        sessionId: userSessionId,
        type: 'parcel',
        customerName: document.getElementById('customerName').value.trim(),
        customerPhone: document.getElementById('customerPhone').value.trim(),
        rider: 'Multiple',
        riderSelections: selectedNames.map(name => ({ name, count: riderSelections[name] })),
        quantity: parseInt(document.getElementById('quantity').value),
        paymentStatus: document.getElementById('paymentStatus').value,
        paymentCost: document.getElementById('paymentStatus').value === 'Not Yet Paid' ? 
                     parseFloat(document.getElementById('paymentCost').value) : 0,
        paymentMethod: document.getElementById('paymentStatus').value === 'Not Yet Paid' ? 
                     document.querySelector('input[name="paymentMethod"]:checked').value : '',
        deliveryLocation: document.getElementById('deliveryLocation').value.trim(),
        notes: document.getElementById('notes').value.trim(),
        timestamp: new Date().toISOString()
      };
      
      submitBooking(formData);
    }
    
    function submitBooking(formData) {
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';
      
      // Submit to Google App Script
      fetch(SCRIPT_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'text/plain;charset=utf-8',
        },
        body: JSON.stringify(formData)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          currentOrderId = data.order_id;
          
          // Show success
          document.getElementById('successMessage').textContent = data.message;
          document.getElementById('orderIdDisplay').innerHTML = `
            <div style="font-size: 14px; margin-bottom: 10px;">Your Order ID:</div>
            <div class="order-id">${currentOrderId}</div>
          `;
          
          document.getElementById('statusSection').style.display = 'block';
          // Save full booking details for summary
          saveOrderState({ orderId: currentOrderId, status: 'pending', booking: lastBookingDetails });
          showBookingSummary(lastBookingDetails);
          showCancelButton();
          
          // Start checking for rider assignment
          startRiderCheck();
          
          // Scroll to status section
          document.getElementById('statusSection').scrollIntoView({ behavior: 'smooth' });
        } else {
          alert('Error: ' + data.message);
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit Parcel Booking';
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error submitting booking. Please try again.');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Parcel Booking';
      });
    }

    // Show booking summary in status section
    function showBookingSummary(details) {
      if (!details) return;
      const el = document.getElementById('bookingSummary');
      el.style.display = 'block';
      el.innerHTML = `
        <div style="background:#f8f9fa; border-radius:10px; padding:14px 18px; border:1px solid #e1e1e1;">
          <div><strong>Name:</strong> ${details.customerName}</div>
          <div><strong>Phone:</strong> ${details.customerPhone}</div>
          <div><strong>Rider(s):</strong> ${Object.entries(details.riderSelections).map(([k,v])=>`${k} (${v})`).join(', ')}</div>
          <div><strong>Quantity:</strong> ${details.quantity}</div>
          <div><strong>Payment:</strong> ${details.paymentStatus}${details.paymentStatus==='Not Yet Paid'?
            ` (‚Ç±${details.paymentCost} - ${details.paymentMethod || 'Cash'})`:''}</div>
          <div><strong>Delivery:</strong> ${details.deliveryLocation}</div>
          ${details.notes ? `<div><strong>Notes:</strong> ${details.notes}</div>` : ''}
        </div>
      `;
    }

    // Show cancel button if pending
    function showCancelButton() {
      const actions = document.getElementById('orderActions');
      actions.style.display = 'block';
      
      // Only show cancel button if we're in pending state (no rider assigned yet)
      const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
      if (!saved.status || saved.status === 'pending') {
        actions.innerHTML = `
          <button class="confirm-btn" style="background:linear-gradient(135deg,#dc3545,#b71c1c);" onclick="cancelBooking()">Cancel Booking</button>
        `;
      }
    }

    // Cancel booking logic
    function cancelBooking() {
      if (!currentOrderId) return;
      if (!confirm('Are you sure you want to cancel this booking?')) return;
      fetch(SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({ action: 'cancel_booking', order_id: currentOrderId })
      })
      .then(r => r.json())
      .then((data) => {
        localStorage.removeItem(STORAGE_KEY);
        stopIntervals();
        document.getElementById('completedMessage').innerHTML = `
          <div class="completed-message">
            <h3>Booking Cancelled</h3>
            <p>Your booking has been cancelled.</p>
            <div style="margin-top:16px;">
              <button class="confirm-btn" onclick="placeNewOrder()">Place New Booking</button>
            </div>
          </div>
        `;
        document.getElementById('orderActions').style.display = 'none';
        document.getElementById('bookingSummary').style.display = 'none';
      })
      .catch(()=>alert('Error cancelling booking. Please try again.'));
    }

    // Prevent duplicate booking: hide form if booking exists
    function disableForm() {
      document.getElementById('parcelForm').style.display = 'none';
    }

    function startRiderCheck() {
      stopIntervals();
      let lastNotificationCheck = Date.now();
      
      checkInterval = setInterval(() => {
        fetch(`${SCRIPT_URL}?action=get_booking_status&order_id=${currentOrderId}&ts=${Date.now()}`)
          .then(response => response.json())
          .then(data => {
            if (!data || !data.success || !data.booking) return;
            const b = data.booking;

            // Keep local in sync so reload won't regress
            if (b.delivery_status) {
              lastKnownDeliveryStatus = b.delivery_status;
              saveOrderState({ orderId: currentOrderId, status: b.status, deliveryStatus: b.delivery_status });
            }

            if (b.delivery_status === 'delivered_by_rider') {
              ensureRiderCard(b);
              syncRiderUIWithStatus(b);
            }
            else if (b.delivery_status === 'item_claimed' || b.delivery_status === 'claimed') {
              ensureRiderCard(b);
              syncRiderUIWithStatus(b);
            }
            else if (b.status === 'assigned') {
              const riderInfoEl = document.getElementById('riderInfo');
              if (!riderInfoEl || riderInfoEl.innerHTML.trim() === '') {
                assignRider(b); // assignRider will call syncRiderUIWithStatus(b)
              } else {
                syncRiderUIWithStatus(b);
              }
            }
            else if (b.status === 'delivered') {
              showCompletedReceipt(b);
              saveOrderState({ orderId: currentOrderId, status: 'delivered', deliveryStatus: 'delivered' });
              stopIntervals();
            }
          })
          .catch(error => console.error('Error checking status:', error));
        
        // More frequent notification polling
        if (Date.now() - lastNotificationCheck > 4000) {
          lastNotificationCheck = Date.now();
          UserNotificationService.pollUserNotifications(SCRIPT_URL, userSessionId, lastNotificationCheck - 30000)
            .then(notifications => {
              UserNotificationService.showUserNotifications(notifications);
            });
        }
      }, 2000); // Poll every 2 seconds
    }

    // Ensure rider card exists before updating status/progress
    function ensureRiderCard(booking) {
      const riderInfoEl = document.getElementById('riderInfo');
      if (!riderInfoEl || riderInfoEl.innerHTML.trim() === '') {
        assignRider(booking);
      }
    }

    // Helper: rank statuses so we never downgrade on reload
    function getStatusRank(s) {
      switch (s) {
        case 'delivered': return 5;
        case 'delivered_by_rider': return 4;
        case 'item_claimed':
        case 'claimed': return 3;
        case 'on_the_way': return 2;
        case 'rider_assigned':
        case 'assigned': return 1;
        case 'waiting_for_rider':
        default: return 0;
      }
    }
    function pickNoDowngrade(incoming, saved) {
      if (!saved) return incoming || null;
      if (!incoming) return saved;
      return getStatusRank(incoming) >= getStatusRank(saved) ? incoming : saved;
    }

    // NEW: sync current delivery_status to UI without allowing downgrade
    function syncRiderUIWithStatus(booking) {
      const statusEl = document.getElementById('riderStatusText');
      const progressFill = document.getElementById('riderProgressFill');

      // read saved deliveryStatus from storage
      let savedStatus = null;
      try {
        const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
        savedStatus = saved && saved.deliveryStatus ? saved.deliveryStatus : null;
      } catch (_) {}

      // compute effective (no-downgrade) delivery_status
      const effectiveStatus = pickNoDowngrade(booking.delivery_status, lastKnownDeliveryStatus || savedStatus);

      // persist progression so future reloads also respect it
      if (effectiveStatus && effectiveStatus !== lastKnownDeliveryStatus) {
        lastKnownDeliveryStatus = effectiveStatus;
        // do not alter other fields; only store deliveryStatus progression
        saveOrderState({ orderId: currentOrderId, status: booking.status || 'assigned', deliveryStatus: effectiveStatus });
      }

      // Final completion guard
      if (booking.status === 'delivered' || effectiveStatus === 'delivered') {
        if (progressFill) progressFill.style.width = '100%';
        showCompletedReceipt(booking);
        return;
      }

      // Use effectiveStatus for UI; never regress back to "assigned"
      if (effectiveStatus === 'delivered_by_rider') {
        if (statusEl) statusEl.textContent = 'Status: Parcel delivered! Please confirm receipt';
        if (progressFill) progressFill.style.width = '90%';
        if (typeof updateOrderActions === 'function') updateOrderActions('delivered_by_rider');
      } else if (effectiveStatus === 'item_claimed' || effectiveStatus === 'claimed') {
        if (statusEl) statusEl.textContent = 'Status: Parcel has been claimed by rider';
        if (progressFill) progressFill.style.width = '75%';
      } else if (effectiveStatus === 'on_the_way' || booking.status === 'assigned') {
        if (statusEl) statusEl.textContent = 'Status: On the way to pickup parcel';
        if (progressFill && !progressFill.style.width) progressFill.style.width = '35%';
      }
    }

    function assignRider(booking) {
      saveOrderState({ orderId: currentOrderId, status: 'assigned', deliveryStatus: booking.delivery_status || lastKnownDeliveryStatus || 'rider_assigned' });
      document.getElementById('riderStatus').innerHTML = `
        <span class="status-indicator status-assigned"></span>
        Rider assigned!
      `;
      
      const riderName = booking.rider_name || 'Your Rider';
      const riderPhone = booking.rider_phone || '';
      const initials = (riderName || '').trim().split(/\s+/).map(p => p[0]).slice(0,2).join('').toUpperCase() || 'R';
      
      document.getElementById('riderInfo').innerHTML = `
        <div class="rider-info">
          <div class="rider-grid">
            <div class="avatar">${initials}</div>
            <div>
              <div class="name-row">
                <h3 style="margin:0;">${riderName}</h3>
                <span class="pill">Assigned</span>
              </div>
              <div class="rider-details"><span>${riderPhone}</span></div>
              <div class="rider-details">ETA: 20‚Äì30 minutes</div>
              <div class="rider-details">
                <span id="riderStatusText">Status: On the way to pickup parcel</span>
              </div>
              <div class="progress">
                <div class="progress-track"><div class="progress-fill" id="riderProgressFill" style="width:35%"></div></div>
              </div>
            </div>
          </div>
          <div id="messagesContainer" style="margin-top:14px; text-align:left;">
            <div style="font-weight:700; margin-bottom:6px;">Messages from your rider</div>
            <div id="messagesList" style="max-height:160px; overflow:auto; background:rgba(255,255,255,0.12); padding:10px; border-radius:10px; color:#000;"></div>
          </div>
          <div class="rider-actions">
            <a class="contact-btn" href="tel:${riderPhone}">üìû Call Rider</a>
          </div>
        </div>
      `;
      
      // Replace cancel with confirm
      document.getElementById('orderActions').innerHTML = `
        <button class="confirm-btn" onclick="confirmDelivery(this)">
          Confirm Parcel Delivery Received
        </button>
      `;
      
      // Immediately sync with actual status so it doesn't show the default after reload
      syncRiderUIWithStatus(booking);
      startMessagesPolling();
    }

    // Update restore to always fetch latest status first and apply immediately
    function restoreFromStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const saved = JSON.parse(raw);
        if (!saved || !saved.orderId) return;

        currentOrderId = saved.orderId;
        lastKnownDeliveryStatus = saved.deliveryStatus || null;

        document.getElementById('statusSection').style.display = 'block';
        document.getElementById('orderIdDisplay').innerHTML = `
          <div style="font-size: 14px; margin-bottom: 10px;">Your Order ID:</div>
          <div class="order-id">${currentOrderId}</div>`;
        if (saved.booking) {
          lastBookingDetails = saved.booking;
          showBookingSummary(saved.booking);
        }
        disableForm();

        // Pre-apply saved delivery status to avoid regression flash while waiting for fetch
        if (saved.status === 'assigned' && saved.deliveryStatus && saved.deliveryStatus !== 'waiting_for_rider') {
          ensureRiderCard({ rider_name: 'Your Rider', rider_phone: '' });
          syncRiderUIWithStatus({ status: 'assigned', delivery_status: saved.deliveryStatus });
        } else if (saved.status === 'delivered') {
          showCompletedReceipt();
        }

        // Always fetch latest status and then re-sync
        fetch(`${SCRIPT_URL}?action=get_booking_status&order_id=${currentOrderId}&ts=${Date.now()}`)
          .then(response => response.json())
          .then(data => {
            if (data.success && data.booking) {
              const b = data.booking;
              if (b.status === 'delivered') {
                showCompletedReceipt(b);
                saveOrderState({ orderId: currentOrderId, status: 'delivered', deliveryStatus: 'delivered' });
                return;
              }
              if (b.status === 'assigned' || b.status === 'confirmed' ||
                  b.delivery_status === 'rider_assigned' || b.delivery_status === 'on_the_way' ||
                  (b.rider_name && b.rider_name.trim() !== '')) {
                assignRider(b); // will sync to b.delivery_status
              } else if (saved.status === 'pending') {
                showCancelButton();
                startRiderCheck();
              } else {
                startRiderCheck();
              }
            } else {
              // Fallback to saved state
              if (saved.status === 'assigned') {
                ensureRiderCard({ rider_name: 'Your Rider', rider_phone: '' });
                if (saved.deliveryStatus) {
                  syncRiderUIWithStatus({ status: 'assigned', delivery_status: saved.deliveryStatus });
                }
                startRiderCheck();
              } else if (saved.status === 'delivered') {
                showCompletedReceipt();
              } else {
                showCancelButton();
                startRiderCheck();
              }
            }
          })
          .catch(() => {
            // Network failure: still show saved state
            if (saved.status === 'assigned') {
              ensureRiderCard({ rider_name: 'Your Rider', rider_phone: '' });
              if (saved.deliveryStatus) {
                syncRiderUIWithStatus({ status: 'assigned', delivery_status: saved.deliveryStatus });
              }
            } else if (saved.status === 'pending') {
              showCancelButton();
            }
            startRiderCheck();
          });
      } catch {}
    }
    
    // Replace/ensure: saveOrderState stores deliveryStatus too
    function saveOrderState(state) {
      try {
        const toSave = {
          orderId: (state && state.orderId) || currentOrderId,
          status: state && state.status,
          deliveryStatus: (state && state.deliveryStatus) || lastKnownDeliveryStatus || (state && state.delivery_status) || null,
          booking: (state && state.booking) || lastBookingDetails
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
      } catch (e) {
        console.warn('saveOrderState failed', e);
      }
    }
    
    function stopMessageIntervalOnly() {
      if (messageInterval) {
        clearInterval(messageInterval);
        messageInterval = null;
      }
    }
    
    function stopIntervals() {
      if (checkInterval) {
        clearInterval(checkInterval);
        checkInterval = null;
      }
      stopMessageIntervalOnly();
    }
    
    function goBack() {
      window.location.href = 'index.html';
    }

    // Add missing placeNewOrder function
    window.placeNewOrder = function() {
      try {
        localStorage.removeItem(STORAGE_KEY);
        stopIntervals();
      } catch (_) {}
      // Reload to bring back the form
      window.location.href = 'index.html';
    };

    // Add notification permission check function
    function checkNotificationPermission() {
      if (!('Notification' in window)) {
        console.warn('This browser does not support notifications.');
        return;
      }

      if (Notification.permission === 'default') {
        const confirmNotifications = confirm('Would you like to receive notifications about your delivery status?');
        if (confirmNotifications) {
          Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
              console.log('Notifications enabled.');
              showNotification('Notifications enabled for delivery updates!');
            } else {
              console.warn('Notifications not enabled.');
            }
          });
        }
      }
    }

    // Add a showNotification function if it doesn't exist
    function showNotification(message, isError = false) {
      // Check if an existing notification container exists
      let notification = document.getElementById('notification');
      
      // Create it if it doesn't exist
      if (!notification) {
        notification = document.createElement('div');
        notification.id = 'notification';
        notification.style.position = 'fixed';
        notification.style.top = '20px';
        notification.style.right = '20px';
        notification.style.padding = '15px 20px';
        notification.style.borderRadius = '10px';
        notification.style.color = 'white';
        notification.style.boxShadow = '0 5px 15px rgba(0,0,0,0.2)';
        notification.style.transform = 'translateX(400px)';
        notification.style.transition = 'transform 0.3s ease';
        notification.style.zIndex = '1001';
        document.body.appendChild(notification);
      }
      
      // Set notification style based on type
      notification.style.background = isError ? '#ef4444' : '#10b981';
      notification.textContent = message;
      
      // Show notification
      setTimeout(() => {
        notification.style.transform = 'translateX(0)';
      }, 10);
      
      // Hide notification after 3 seconds
      setTimeout(() => {
        notification.style.transform = 'translateX(400px)';
      }, 3000);
    }

    // Call this function on page load to check for existing permissions
    document.addEventListener('DOMContentLoaded', function() {
      // Existing initialization code
      // ...existing code...
      
      // Guard Notification API to avoid ReferenceError on unsupported browsers
      if ('Notification' in window && Notification.permission === 'granted') {
        console.log('Notifications already enabled.');
      }
    });

    // Ensure confirmDelivery is globally accessible for inline onclick handlers
    window.confirmDelivery = function(btn) {
      try {
        // disable clicked button immediately
        if (btn) {
          btn.disabled = true;
          btn.dataset.origText = btn.textContent;
          btn.textContent = 'Processing...';
        }
        
        fetch(SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({ action: 'complete_booking', order_id: currentOrderId })
        })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            // persist final state to prevent regress on reload
            saveOrderState({ orderId: currentOrderId, status: 'delivered', deliveryStatus: 'delivered' });
            const statusEl = document.getElementById('riderStatusText');
            if (statusEl) statusEl.textContent = 'Status: Completed';
            const progressFill = document.getElementById('riderProgressFill');
            if (progressFill) progressFill.style.width = '100%';
            showCompletedReceipt(data);
            if (typeof stopIntervals === 'function') stopIntervals();
          } else {
            alert('Error completing order: ' + data.message);
            if (btn) { btn.disabled = false; btn.textContent = btn.dataset.origText || 'Confirm Parcel Delivery Received'; }
          }
        })
        .catch(err => {
          console.error('Error:', err);
          alert('Error completing order. Please try again.');
          if (btn) { btn.disabled = false; btn.textContent = btn.dataset.origText || 'Confirm Parcel Delivery Received'; }
        });
      } catch (e) {
        console.error('confirmDelivery error', e);
        if (btn) { btn.disabled = false; btn.textContent = btn.dataset.origText || 'Confirm Parcel Delivery Received'; }
      }
    };

    // Ensure startMessagesPolling exists to avoid ReferenceError if not provided by another script
    if (typeof window.startMessagesPolling !== 'function') {
      window.startMessagesPolling = function() {};
    }

    // Update showCompletedReceipt to include more complete receipt information
    window.showCompletedReceipt = function(payload) {
      try {
        // Stop background timers
        if (typeof stopIntervals === 'function') stopIntervals();

        // Persist final state
        saveOrderState({ orderId: currentOrderId, status: 'delivered', deliveryStatus: 'delivered' });

        // Update top status
        const riderStatus = document.getElementById('riderStatus');
        if (riderStatus) {
          riderStatus.innerHTML = '<span class="status-indicator status-assigned"></span> Delivery completed.';
        }

        // Hide actions and summary
        const actions = document.getElementById('orderActions');
        if (actions) actions.style.display = 'none';

        // Show completion card with more detailed receipt information
        const message = (payload && payload.message) ? payload.message : 'Your parcel has been delivered successfully.';
        const completed = document.getElementById('completedMessage');
        if (completed) {
          completed.innerHTML = `
            <div class="completed-message">
              <h3>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; margin-right: 8px;">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                  <polyline points="22,4 12,14.01 9,11.01"/>
                </svg>
                Parcel Delivery Completed!
              </h3>
              <p>Thank you for using Aup Grab. ${message}</p>
              <p style="margin-top: 15px;">Order ID: <strong>${currentOrderId}</strong></p>
              <div style="margin-top:16px;">
                <button class="confirm-btn" onclick="placeNewOrder()">Place New Booking</button>
              </div>
            </div>
          `;
        }
      } catch (e) {
        console.warn('showCompletedReceipt error', e);
      }
    };

    // NEW: match food.html "delivered_by_rider" UI (banner + big confirm button)
    function updateOrderActions(deliveryStatus) {
      const actionsEl = document.getElementById('orderActions');
      if (!actionsEl) return;

      if (deliveryStatus === 'delivered_by_rider') {
        actionsEl.innerHTML = `
          <div style="text-align: center; margin-bottom: 15px;">
            <div style="color: #2d5016; font-weight: bold; margin-bottom: 10px; font-size: 16px;">
              ‚úì Your parcel has been delivered!
            </div>
            <div style="color: #666; margin-bottom: 15px;">
              Please confirm when you have received your parcel
            </div>
          </div>
          <button class="confirm-btn"
                  style="background: linear-gradient(135deg, #ad7b05, #c9b820); width: 100%; padding: 16px; font-size: 16px; animation: pulse 2s infinite; transform: scale(1.05); box-shadow: 0 4px 12px rgba(173, 123, 5, 0.3);"
                  onclick="confirmDelivery(this)">
            Confirm Parcel Delivery Received
          </button>
        `;
      } else if (!actionsEl.innerHTML.includes('confirm-btn')) {
        // Fallback: keep a plain confirm button if not yet present
        actionsEl.innerHTML = `
          <button class="confirm-btn" onclick="confirmDelivery(this)">
            Confirm Parcel Delivery Received
          </button>
        `;
      }
    }
  </script>
  <script src="info-modal.js"></script>
  <script src="notifications.js"></script>
  <script src="notification-banner.js"></script>
 </body>
</html>
